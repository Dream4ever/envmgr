# EnvMgr 项目功能说明

## 1. 项目定位与概览

EnvMgr 是一个用于“多环境配置文件管理”的 Web 面板，核心目标是把项目在不同环境（本地 / 校内 / 阿里云）的 `.env` 或类似配置文件统一纳入可视化管理：
- 以“项目”为单位配置不同环境的基础路径和文件清单。
- 在线读取、编辑、校验配置内容，并维护可回滚/可对比的待同步版本副本。
- 对远端环境通过 SSH 进行读取与同步，避免手工传输。

## 2. 核心功能

### 2.1 项目与环境管理

- **项目列表**：从 `data/projects.json` 读取项目列表，侧边栏可快速切换。
- **新建/编辑/删除项目**：支持创建项目、修改名称/备注/环境配置、删除项目。
- **环境配置结构**：每个项目包含三个固定环境：
  - `local`：本地环境
  - `campus`：校内服务器
  - `aliyun`：阿里云服务器
- **环境配置字段**：
  - `basePath`：环境基础路径
  - `hostAlias`（远端必填）：SSH 配置中的别名
  - `files`：允许管理的文件列表（逐行输入）
  - `notes`：可选备注

### 2.2 配置文件读取与来源标记

- **读取逻辑**：
  - `local` 环境直接读取本地文件。
  - `campus`/`aliyun` 环境通过 SSH `cat` 读取远端文件。
- **待同步版本优先**：若待同步版本存在同一文件副本，界面优先展示待同步版本内容，并标记来源为“待同步版本”。
- **来源显示**：界面显示内容来源（本地 / 远端 / 待同步版本）、文件路径、待同步版本是否已存在。

### 2.3 编辑与保存

- **内容编辑**：页面内直接编辑文件内容。
- **保存行为**：
  - 无论任何环境，保存都会写入待同步版本文件。
  - 仅 `local` 环境保存时，同时写回本地文件。
- **格式校验**：保存/读取时对 `.env` 内容进行基础校验（例如缺失 `=`、变量名不合法），并在 UI 中提示警告。

### 2.4 远端同步

- **同步范围**：仅用于 `campus`/`aliyun` 环境。
- **同步方式**：将待同步版本文件通过 `scp` 上传到远端目标路径。
- **限制**：
  - 必须配置 `hostAlias`。
  - 必须已有待同步版本文件（即先读取或保存过）。

### 2.5 差异对比

- **对比对象**：当前环境的“源文件内容” vs 待同步版本内容。
- **使用场景**：快速查看改动点，确认是否需要同步。

### 2.6 审计日志

- **记录内容**：项目创建/更新/删除、环境保存、远端同步等操作。
- **存储位置**：`data/audit.log`，每行一条 JSON。
- **接口输出**：`/api/audit` 返回最近 200 条记录。

## 3. 数据与存储结构

- **项目配置**：`data/projects.json`
- **待同步版本副本**：`data/workspace/<projectId>/<env>/<file>`
- **审计日志**：`data/audit.log`
- **自动初始化**：数据目录与文件缺失时自动创建。

## 4. 安全与校验机制

- **环境限定**：仅允许 `local` / `campus` / `aliyun` 三种环境键。
- **文件白名单**：只允许访问项目配置中明确列出的文件名。
- **本地路径防越界**：本地文件路径必须在 `basePath` 内。
- **远端路径校验**：禁止 `..` 等不安全路径，限制为安全字符。
- **SSH 连接约束**：采用 `BatchMode` 与超时，避免交互式阻塞。

## 5. 接口一览（前端对接）

- `GET /api/projects`：获取项目列表
- `POST /api/projects`：创建项目
- `GET /api/projects/:id`：获取单个项目
- `PUT /api/projects/:id`：更新项目
- `DELETE /api/projects/:id`：删除项目
- `GET /api/env`：读取指定环境文件（含待同步版本信息与校验提示）
- `PUT /api/env`：保存环境文件（写入待同步版本，local 同时落盘）
- `GET /api/diff`：待同步版本与源文件差异对比
- `POST /api/sync`：同步待同步版本到远端
- `GET /api/audit`：获取审计日志

## 6. 页面交互概述

- **左侧**：项目列表与快捷操作（新建、刷新）。
- **中部**：环境切换、文件选择、编辑与对比视图。
- **右侧**：项目设置面板（环境路径、SSH 别名、文件列表）。
